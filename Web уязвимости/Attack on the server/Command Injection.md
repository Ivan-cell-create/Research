# Command Injection (Инъекция команд)

## Что такое Command Injection

Command Injection — это уязвимость, при которой злоумышленник внедряет и выполняет произвольные системные команды на сервере через уязвимые точки приложения. Чаще всего возникает, если приложение принимает пользовательский ввод и напрямую подставляет его в вызов командной оболочки (например, через функции `exec()`, `system()`, `shell_exec()` в PHP или аналогичные в других языках).

**Почему это опасно?**

- Возможен полный контроль над сервером  
- Кража, изменение или удаление данных  
- Размещение вредоносного ПО  
- Использование сервера для атак на другие системы  

---

## Как происходит Command Injection

Уязвимость возникает, когда:

- Входные данные пользователя включаются в команду без проверки и фильтрации  
- Используются функции, позволяющие выполнить команды ОС  
- Нет разделения между командой и данными (например, напрямую конкатенация строк)  

---

## Пример небезопасного кода (PHP)

```php
$filename = $_GET['file'];
$output = shell_exec("cat " . $filename);
echo "<pre>$output</pre>";
```

Если передать параметр:

```ini
file=somefile.txt; ls -la /etc
```

То фактически будет выполнена команда:

```bash
file=somefile.txt; ls -la /etc
```

В результате кроме содержимого файла выведется список файлов в /etc — злоумышленник запускает произвольную команду.


| Метод                 | Суть                                                         | Примечание                         |
|-----------------------|--------------------------------------------------------------|-----------------------------------|
| **Избегать вызова оболочки** | Использовать API для работы с файлами и процессами вместо системных команд | Самый надёжный способ              |
| **Белый список**      | Разрешать только проверенные, заранее известные значения параметров | Например, выбор из фиксированных опций |
| **Экранирование/санитизация** | Использовать функции, которые безопасно экранируют спецсимволы | Например, `escapeshellarg()` и `escapeshellcmd()` в PHP |
| **Разделение команд и аргументов** | Использовать параметры, передаваемые отдельно (например, `proc_open` или `exec` с массивом аргументов) | Позволяет избежать интерпретации оболочкой |
| **Минимизация прав**  | Запускать сервер и процессы под ограниченными пользователями | Для снижения ущерба при взломе    |
| **Логирование**       | Фиксация подозрительной активности для последующего анализа |                                    |

---

## Пример безопасного кода с `escapeshellarg()` (PHP)

```php
$filename = $_GET['file'];
$safe_filename = escapeshellarg($filename);
$output = shell_exec("cat " . $safe_filename);
echo "<pre>$output</pre>";
```

Если file = somefile.txt; rm -rf /, то escapeshellarg() превратит аргумент в 'somefile.txt; rm -rf /' и команда выполнится как:

```bash
cat 'somefile.txt; rm -rf /'
```

Что безопасно, потому что вся строка воспринимается как имя файла.

## Почему простое удаление спецсимволов — неэффективно

- Спецсимволов и способов обхода очень много (`;`, `&&`, `|`, `$()`, ```` и другие)  
- Сложно предусмотреть все варианты, особенно при разной кодировке и оболочках  
- Часто лучше использовать API без оболочки или тщательно экранировать  

---

## Резюме

- **Command Injection** — критическая уязвимость, приводящая к выполнению произвольных системных команд.  
- Главная причина — включение пользовательского ввода в команды без надёжной проверки и разделения.  
- Защищаться стоит с помощью использования безопасных API, белых списков и правильного экранирования.  
- Минимизация прав и логирование помогают снизить ущерб и быстро обнаружить атаки.

---

## Полезные ссылки и литература

- [OWASP Command Injection](https://owasp.org/www-community/attacks/Command_Injection)  
- [PHP manual: escapeshellarg](https://www.php.net/manual/ru/function.escapeshellarg.php)  
- [Secure Coding: Command Injection Prevention](https://www.veracode.com/security/command-injection)  
- [Exploit-DB: Command Injection examples](https://www.exploit-db.com/)  


## Важное замечание

> Вся информация предоставлена исключительно в учебных целях. Используйте её для повышения безопасности, а не для нанесения вреда.