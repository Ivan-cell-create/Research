# SQL-инъекция

## Что такое SQL-инъекция

SQL-инъекция — это атака, при которой злоумышленник внедряет произвольный SQL-код в динамический запрос к базе данных. Это возможно, если:

- ввод пользователя напрямую включается в текст запроса,  
- отсутствуют проверки/валидация/очистка данных,  
- код не использует разделение “шаблон-запроса” и “данные”.

**Последствия:**

- Чтение (утечка) конфиденциальной информации  
- Изменение или удаление данных  
- Обход авторизации  
- Возможен полный контроль над БД или сервером

---

## Основные виды SQL-инъекций

1. **Классическая SQL-инъекция** — подстановка напрямую в `WHERE`, `ORDER BY`, и т.п.  
2. **Error-based SQLi** — извлечение информации через ошибки СУБД  
3. **Blind SQLi** — нет ошибок/вывода, используется логика и время отклика  
4. **Union-based** — объединение результатов с помощью `UNION`  
5. **Time-based** — замедление ответа через `SLEEP()` и анализ времени

---

## Пример небезопасного кода (PHP)

```php
$username = $_POST['username'];
$password = $_POST['password'];
$query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
$result = mysqli_query($conn, $query);
```

Если в username подставить:

```bash
' OR '1'='1


Запрос станет:

```sql
SELECT * FROM users WHERE username = '' OR '1'='1' AND password = '';
```

Это условие всегда истинно = обход авторизации.


## Методы защиты

| Метод                  | Суть                                                         | Примечание                              |
|------------------------|--------------------------------------------------------------|------------------------------------------|
| **Prepared Statements**| Запрос и данные передаются отдельно, используется `?` или `:name` | Самый надёжный способ                    |
| **ORM и библиотеки**   | Использование слоёв абстракции                               | Требует понимания, как работает внутри   |
| **Валидация входа**    | Проверка формата, типа, длины и т.д.                         | Обязательна для бизнес-логики            |
| **Экранирование**      | Использование `mysqli_real_escape_string()` и аналогов       | Не рекомендуется как основное средство   |
| **Ограничение прав БД**| Пользователю БД выдаются только нужные права                 | Уменьшает потенциальный ущерб            |
| **Логирование**        | Фиксация аномалий и подозрительных действий                  | Для анализа и расследования              |


## Реализация в PHP

### С использованием PDO

```php
$pdo = new PDO($dsn, $user, $pass, [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_EMULATE_PREPARES => false
]);

$stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username AND password = :password");
$stmt->execute([
    ':username' => $username_input,
    ':password' => $password_input
]);
$user = $stmt->fetch();
```

### С использованием MySQLi

```php
$conn = new mysqli($host, $user, $pass, $db);
$stmt = $conn->prepare("SELECT id FROM users WHERE email = ?");
$stmt->bind_param("s", $email_input);
$stmt->execute();
$result = $stmt->get_result();
```

## Почему простое экранирование / удаление символов — не надёжно

- Одинарная кавычка или слэши — далеко не все возможные точки входа.
- Спецрежимы SQL, разные СУБД, типы кавычек, Unicode-кодировки — всё это может “сломать” защиту, если полагаться только на экранирование.
- Эмуляция подготовленных выражений может дать ложное чувство безопасности.
- Невалидные бизнес-условия: даже если данные “безопасны” с точки зрения SQL, они могут нарушать логику приложения (например, отрицательные числа там, где должны быть только положительные) — это также уязвимость.

---

## Резюме

- **SQL-инъекции** — одна из самых серьёзных и распространённых уязвимостей.
- **Подготовленные выражения + параметризация + строгая валидация** — основные способы защиты.
- Не стоит полагаться на простое экранирование без понимания контекста и ограничений.
- **Минимизация прав доступа и логирование** помогают снизить ущерб и ускоряют обнаружение атаки.

---

## Используемая литература / ресурсы

- [Документация PHP: подготовленные выражения в mysqli](https://www.php.net/manual/ru/mysqli.quickstart.prepared-statements.php)
- [Подготовленные выражения в PDO — code.mu](https://code.mu/ru/php/book/supreme/pdo/prepared-statements/)
- [Habr: Самый частый шаблон SQL инъекций в PHP — бесполезное экранирование символов](https://habr.com/ru/articles/142599/)
- [codeurjava.com: Защита от SQL-инъекций в PHP](https://www.codeurjava.com/ru/php/%D0%97%D0%B0%D1%89%D0%B8%D1%82%D0%B0-%D0%BE%D1%82-sql-%D0%B8%D0%BD%D1%8A%D0%B5%D0%BA%D1%86%D0%B8%D0%B9-%D0%B2-php.html)
- [Википедия: Внедрение SQL-кода](https://ru.wikipedia.org/wiki/Внедрение_SQL-кода)